---
title: "Comparaison packages boral et jSDM"
author: "Jeanne Clément"
date: "23/08/2019"
output:
  pdf_document: default
  html_document: default
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(
  fig.align = "center",
  fig.width = 7, fig.height = 7,
  cache = TRUE,
  collapse = TRUE,
  comment = "#>",
  highlight = TRUE
)
```

# Models definition 

## Binomial models for presence-absence data

We consider a latent variable model (LVM) to account for species co-occurrence on all sites . 

$$y_{ij} \sim \mathcal{B}iniomial(t_i, \theta_{ij})$$
  
  $$ \mathrm{probit}(\theta_{ij}) = \alpha_i + X_i\beta_j + W_i\lambda_j $$
- $\theta_{ij}$: occurence probability of the species $j$ on site $i$. 
- $t_i$: number of visits at site $i$ 


The inference method is able to handle only one visit by site with a **probit** link function so $\forall i, \ t_i=1$ and $y_{ij} \sim \mathcal{B}ernoulli(\theta_{ij})$.

- $\alpha_i$: Site random effect with $\alpha_i \sim \mathcal{N}(0, V_{\alpha})$. Corresponds to a mean suitability for site $i$.
- $X_i$: Vector of explanatory variables for site $i$ (including intercept).
- $\beta_j$: Effects of the explanatory variables on the probability of presence of species $j$.
- $W_i$: Vector of random latent variables for site $i$. $W_i \sim N(0, 1)$. The number of latent variables must be fixed by the user (default to 2).
- $\lambda_j$: Effects of the latent variables on the probability of presence of species $j$. Also known as "factor loadings".

This model is equivalent to a multivariate GLMM $\mathrm{probit}(\theta_{ij}) =\alpha_i + X_i.\beta_j + u_{ij}$, where $u_{ij} \sim \mathcal{N}(0, \Sigma)$ with the constraint that the variance-covariance matrix $\Sigma = \Lambda \Lambda^{\prime}$, where $\Lambda$ is the full matrix of factor loadings, with the $\lambda_j$ as its columns. 

# Data-sets
 
Among the following datasets, the presence-absence data are from the (Wilkinson2019) article in which they are used to compare joint species distribution models for presence-absence data. 

```{r data-sets, echo=FALSE, eval=TRUE}
library(knitr)
library(kableExtra)
library(jSDM)
library(boral)
# Mosquitos dataset
data("mosquitos")
PA_Mosquitos <- mosquitos[,1:16]
Env_Mosquitos <- mosquitos[,17:29]
mf.suit <- model.frame(formula=~., data=as.data.frame(Env_Mosquitos))
X_Mosquitos <- model.matrix(attr(mf.suit,"terms"), data=mf.suit)
# Eucalypts dataset
data("eucalypts")
PA_Eucalypts <- eucalypts[,1:12]
Env_Eucalypts <- cbind(scale(eucalypts[,c("Rockiness","VallyBotFlat","PPTann", "cvTemp","T0")]),eucalypts[,c("Sandiness","Loaminess")])
Env_Eucalypts <- Env_Eucalypts[rowSums(PA_Eucalypts) != 0,]
# Remove sites where none species was recorded
PA_Eucalypts<- PA_Eucalypts[rowSums(PA_Eucalypts) != 0,]
mf.suit <- model.frame(formula=~., data=as.data.frame(Env_Eucalypts))
X_Eucalypts <- model.matrix(attr(mf.suit,"terms"), data=mf.suit)
# Frogs dataset
data("frogs")
PA_Frogs <- frogs[,4:12]
Env_Frogs <- cbind(scale(frogs[,"Covariate_1"]),frogs[,"Covariate_2"],scale(frogs[,"Covariate_3"]))
mf.suit <- model.frame(formula=~., data=as.data.frame(Env_Frogs))
X_Frogs <- model.matrix(attr(mf.suit,"terms"), data=mf.suit)
# Fungi dataset
data(fungi, package="jSDM")
Env_Fungi <- cbind(scale(fungi[,c("diam","epi","bark")]),
                   fungi[,c("dc1","dc2","dc3","dc4","dc5",
                            "quality3","quality4","ground3","ground4")])
colnames(Env_Fungi) <- c("diam","epi","bark","dc1","dc2","dc3","dc4","dc5",
                         "quality3","quality4","ground3","ground4")
PA_Fungi <- fungi[,c("antser","antsin","astfer","fompin","hetpar","junlut",
                     "phefer","phenig","phevit","poscae","triabi")]
Env_Fungi <- Env_Fungi[rowSums(PA_Fungi) != 0,]
# Remove sites where none species was recorded
PA_Fungi<- PA_Fungi[rowSums(PA_Fungi) != 0,]
mf.suit <- model.frame(formula=~., data=as.data.frame(Env_Fungi))
X_Fungi <- model.matrix(attr(mf.suit,"terms"), data=mf.suit)

datasets <- data.frame(matrix(NA,8,5),row.names=c( "n.site","n.species","n.latent","n.X.coefs", "n.obs",  "n.param", "n.mcmc",""))
colnames(datasets) <- c("Simulated","Mosquitos","Eucalypts","Frogs","Fungi") 
datasets["n.site",] <- c(300,nrow(mosquitos),nrow(Env_Eucalypts), nrow(frogs), nrow(Env_Fungi))
datasets["n.X.coefs",] <- c(3,ncol(X_Mosquitos),ncol(X_Eucalypts),ncol(X_Frogs),ncol(X_Fungi))
datasets["n.species",] <- c(100,ncol(PA_Mosquitos),ncol(PA_Eucalypts),ncol(PA_Frogs),ncol(PA_Fungi))
datasets["n.latent",] <- 2
datasets["n.obs",] <- datasets["n.site",]*datasets["n.species",] 
datasets["n.mcmc",] <- 15000
datasets["n.param",] <- datasets["n.site",]*(1+datasets["n.latent",])+1+datasets["n.species",]*(datasets["n.X.coefs",]+datasets["n.latent",])-1
sp_pictures <- c("presentation/figs/des.jpg",
                 "figures/Mosquitos_.jpg","presentation/figs/Eucalyptus_.jpg",
                 "presentation/figs/Frogs_.jpg","presentation/figs/Fungi_.jpg")
datasets["",] <- sprintf('![](%s){height="100px" width="100px"}',sp_pictures)
knitr::kable(datasets, booktabs=TRUE) %>%
  kableExtra::kable_styling(latex_options=c("striped"), full_width=FALSE) 
```

In the article (Warton2015) the fitting of joint species distributions models is performed using the package `boral` which runs with `JAGS` (Just Another Gibbs Sampler) a simulation program from hierarchical Bayesian models using MCMC methods implemented in C++. 
This package and the package `jSDM` allow to fit the model defined previously, so we can compare the results obtained by each of them on different datasets. 

# Comparison between packages boral and jSDM 

## Simulated dataset :300 sites and 100 species

### Fit with boral

```{r simulation-dataset, echo=F, include=F,eval=F}

# Toy example : 
nsp <- 100
nsite <- 300
nl <- 2
seed <- 1234
set.seed(seed)

# Ecological process (suitability)
x1 <- rnorm(nsite,0,1)
x2 <- rnorm(nsite,0,1)
X <- cbind(rep(1,nsite),x1,x2)
np <- ncol(X)

# Simulation of parameters
W <- cbind(rnorm(nsite,0,1),rnorm(nsite,0,1))
data=cbind (X,W)
beta.target <- t(matrix(runif(nsp*np,-2,2), byrow=TRUE, nrow=nsp))
l.zero <- 0
l.diag <- runif(2,0,2)
l.other <- runif(nsp*2-3,-2,2)
lambda.target <- t(matrix(c(l.diag[1],l.zero,l.other[1],l.diag[2],l.other[-1]), byrow=T, nrow=nsp))
param.target <- rbind(beta.target,lambda.target)
param.target=rbind(beta.target,lambda.target)
V_alpha.target=0.5
V=1
alpha.target <- rnorm(nsite,0,sqrt(V_alpha.target))

# Simulation of response data with probit link
probit_theta=X %*% beta.target + W %*% lambda.target + alpha.target
e=matrix(rnorm(nsp*nsite,0,sqrt(V)),nsite,nsp)
Z_true <- probit_theta + e
Y=matrix (NA, nsite,nsp)
for (i in 1:nsite){
  for (j in 1:nsp){
    if ( Z_true[i,j] > 0) {Y[i,j] <- 1}
    else {Y[i,j] <- 0}
  }
}
```

```{r boral-simulation, cache=TRUE, echo=F, include=F, eval=F}
library(boral)
T1<-Sys.time() 
mod_boral_sim <- boral(y=Y, X=X[,-1], lv.control=list(num.lv=nl, type="independent", distmat=NULL), family="binomial", row.eff="random", row.ids=matrix(c(1:nsite),ncol=1), save.model=TRUE, calc.ics=F, hypparams=c(10,10,10,30), mcmc.control=list(n.burnin=10000, n.iteration=15000,n.thin=15,seed=123))
T2<-Sys.time() 
T_boral_sim=difftime(T2, T1,units="mins")

# Probit des probabilités de présence theta 
probit_theta_pred_sim <- mod_boral_sim$row.coefs$ID1$mean + 
  X[,-1] %*% t(mod_boral_sim$X.coefs.mean) + 
  X[,1] %*% mod_boral_sim$lv.coefs.mean[,"beta0"] + 
  mod_boral_sim$lv.mean%*%t(mod_boral_sim$lv.coefs.mean[,-1])

# RMSE
SE=(probit_theta-probit_theta_pred_sim)^2
RMSE_boral_sim=sqrt(sum(SE/(nsite*nsp)))
# Deviance 
logL=0
for (i in 1:nsite){
  for (j in 1:nsp){
    theta <- pnorm(probit_theta_pred_sim[i,j])
    logL=logL + dbinom(Y[i,j],1,theta,1)  
  }
}
Deviance_boral_sim <- -2*logL
```

### Fit with jSDM 
```{r jSDM-simulation, cache=TRUE, echo=F, include=F,eval=F}
library(jSDM)

# Fit the model
T1<-Sys.time() 
mod_jSDM_sim <-  jSDM_probit_block(
  presence_site_sp=Y, 
  site_suitability=~.,   
  site_data=as.data.frame(X[,-1]), n_latent=2,
  burnin=10000, mcmc=15000, thin=15,
  alpha_start=0, beta_start=0, lambda_start=0, W_start=0,
  V_alpha_start=1, shape=0.5, rate=0.0005,
  mu_beta=0, V_beta=1.0E6,
  mu_lambda=0, V_lambda=10,
  seed=123, verbose=1)
T2<-Sys.time() 
T_jSDM_sim=difftime(T2, T1,units="mins")

# RMSE
SE=(probit_theta-mod_jSDM_sim$probit_theta_pred)^2
RMSE_jSDM_sim=sqrt(sum(SE/(nsite*nsp)))
```

### Comparison of estimated parameters 

```{r jSDM-boral-simulation, echo=F}
# Alpha et V_alpha
par(mfrow=c(1,1))
plot(mod_boral_sim$row.coefs$ID1$mean, colMeans(mod_jSDM_sim$mcmc.alpha), xlab="alphas estimés par boral", ylab="alphas estimés par  jSDM", main="Effets sites alphas",cex.lab=1.5,cex.main=1.5,font.lab=2)
abline(a=0,b=1,col='red')
points(mod_boral_sim$row.sigma$ID1["mean"],mean(mod_jSDM_sim$mcmc.V_alpha),
       pch=18, col ='red',cex=2.5)
legend("bottomright", legend=c("V_alpha"), pch =18 , col ='red',pt.cex =2, cex=1.2)
# Betas
jSDM_betas <- matrix(0,nsp,np)
for (j in 1:nsp){
  for (p in 1:np){
    jSDM_betas[j,p] <- mean(mod_jSDM_sim$mcmc.sp[[paste0("sp_",j)]][,p])
  }
}
boral_betas <- cbind(mod_boral_sim$lv.coefs.mean[,"beta0"],mod_boral_sim$X.coefs.mean)

plot(boral_betas,jSDM_betas, xlab="betas estimés par boral", ylab="betas estimés par jSDM", main="Effets espèces betas",cex.lab=1.5,cex.main=1.5,font.lab=2)
abline(a=0,b=1,col='red')

# Lambdas
jSDM_lambdas <- matrix(0,nsp,nl)
for (j in 1:nsp){
  for (l in 1:nl){
    jSDM_lambdas[j,l] <- mean(mod_jSDM_sim$mcmc.sp[[paste0("sp_",j)]][,np+l])
  }
}
boral_lambdas <- mod_boral_sim$lv.coefs.mean[,-1]

plot(boral_lambdas,jSDM_lambdas, xlab="lambdas estimés par boral ", ylab="lambdas estimés par jSDM", main="Effets espèces lambdas ", cex.lab=1.5,cex.main=1.5,font.lab=2)
abline(a=0,b=1,col='red')

# Ws
jSDM_lvs <- matrix(0,nsite,nl)
for (l in 1:nl){
  jSDM_lvs[,l] <- colMeans(mod_jSDM_sim$mcmc.latent[[paste0("lv_",l)]])
}
plot(mod_boral_sim$lv.mean, jSDM_lvs, xlab="variables latentes estimées par boral", ylab="variables latentes estimées par jSDM", main="Variables latentes W1 et W2", cex.lab=1.5,cex.main=1.5,font.lab=2)
abline(a=0,b=1,col='red')

# Predictions 
plot(probit_theta_pred_sim, mod_jSDM_sim$probit_theta_pred, xlab="probit(theta) estimés par boral", ylab="probit(theta) estimés par jSDM", main="Probit des probabilités de présence theta ", cex.lab=1.5,cex.main=1.5,font.lab=2)
abline(a=0,b=1,col='red')
```

## Mosquitos dataset : 167 sites and 16 species 

### Fit with boral
```{r boral-Mosquitos, cache=TRUE, echo=F, include=F,eval=F}
# Import center and reduce Mosquito dataset
data(mosquitos, package="jSDM")
head(mosquitos)
Env_Mosquitos <- mosquitos[,17:29]
Env_Mosquitos <- cbind(scale(Env_Mosquitos[,1:4]), Env_Mosquitos[,5:13])
PA_Mosquitos <- mosquitos[,1:16]

# Fit the model 
T1 <- Sys.time()
mod_boral_Mosquitos <- boral(y=PA_Mosquitos, X=Env_Mosquitos, lv.control=list(num.lv=2, type="independent", distmat=NULL), family="binomial", row.eff="random", row.ids=matrix(c(1:nrow(PA_Mosquitos)),ncol=1), save.model=TRUE, calc.ics=F, hypparams=c(10,10,10,30), mcmc.control=list(n.burnin=10000, n.iteration=15000,n.thin=15,seed=123))
T2 <- Sys.time()
T_boral_Mosquitos <- difftime(T2,T1,units="mins")

# Probit des probabilités de présence theta  
probit_theta_pred_Mosquitos <- mod_boral_Mosquitos$row.coefs$ID1$mean + as.matrix(Env_Mosquitos) %*% t(mod_boral_Mosquitos$X.coefs.mean)  + matrix(1,nrow=nrow(PA_Mosquitos), ncol=1)%*%mod_boral_Mosquitos$lv.coefs.mean[,"beta0"] + mod_boral_Mosquitos$lv.mean%*%t(mod_boral_Mosquitos$lv.coefs.mean[,-1])

# Deviance
logL=0
for (i in 1:nrow(PA_Mosquitos)){
  for (j in 1:ncol(PA_Mosquitos)){
    theta <- pnorm(probit_theta_pred_Mosquitos[i,j])
    logL=logL + dbinom(PA_Mosquitos[i,j],1,theta,1)  
  }
}
Deviance_boral_Mosquitos <- -2*logL
```

### Fit with jSDM

```{r jSDM-Mosquitos, cache=TRUE, echo=F, include=F,eval=F}
# Fit the model
T1 <- Sys.time()
mod_jSDM_Mosquitos <- jSDM_probit_block(
  presence_site_sp=as.matrix(PA_Mosquitos), 
  site_suitability=~.,   
  site_data=Env_Mosquitos, n_latent=2,
  burnin=10000, mcmc=15000, thin=15,
  alpha_start=0, beta_start=0, lambda_start=0, W_start=0,
  V_alpha_start=1, shape=0.5, rate=0.0005,
  mu_beta=0, V_beta=1.0E6,
  mu_lambda=0, V_lambda=10,
  seed=123, verbose=1)
T2 <- Sys.time()
T_jSDM_Mosquitos <- difftime(T2,T1,units="mins")
```

### Comparison of estimated parameters 
```{r jSDM-boral-Mosquitos, echo=F}
print(paste(nrow(PA_Mosquitos),"sites and ",ncol(PA_Mosquitos)," species"), quote=F)
nsp <- ncol(mod_jSDM_Mosquitos$model_spec$presences)
nsite <- nrow(mod_jSDM_Mosquitos$model_spec$presences)
nl <- mod_jSDM_Mosquitos$model_spec$n_latent
np <- nrow(mod_jSDM_Mosquitos$model_spec$beta_start)
# Alpha et V_alpha
par(mfrow=c(1,1))
plot(mod_boral_Mosquitos$row.coefs$ID1$mean,colMeans(mod_jSDM_Mosquitos$mcmc.alpha), xlab="alphas estimés par boral", ylab="alphas estimés par  jSDM", main="Effets sites alphas", cex.lab=1.5,cex.main=1.5,font.lab=2)
abline(a=0,b=1,col='red')
points(mod_boral_Mosquitos$row.sigma$ID1["mean"],mean(mod_jSDM_Mosquitos$mcmc.V_alpha), pch=18, col ='red',cex=2.5)
legend("bottomright", legend=c("V_alpha"), pch =18 , col ='red',pt.cex =2, cex=1.2)

# Betas
jSDM_betas <- matrix(0,nsp,np)
for (j in 1:nsp){
  jSDM_betas[j,] <- summary(mod_jSDM_Mosquitos$mcmc.sp[[paste0("sp_",j)]])[[1]][1:np,"Mean"]
}
boral_betas <- cbind(mod_boral_Mosquitos$lv.coefs.mean[,"beta0"],mod_boral_Mosquitos$X.coefs.mean)

plot(boral_betas,jSDM_betas, xlab="betas estimés par boral", ylab="betas estimés par jSDM", main="Effets espèces betas ",cex.lab=1.5,cex.main=1.5,font.lab=2)
abline(a=0,b=1,col='red')

# Lambdas
jSDM_lambdas <- matrix(0,nsp,nl)
for (j in 1:nsp){
  jSDM_lambdas[j,] <- summary(mod_jSDM_Mosquitos$mcmc.sp[[paste0("sp_",j)]])[[1]][(np+1):(np+nl),"Mean"]
}
boral_lambdas <- mod_boral_Mosquitos$lv.coefs.mean[,-1]

plot(boral_lambdas,jSDM_lambdas, xlab="lambdas estimés par boral ", ylab="lambdas estimés par jSDM", main="Effets espèces lambdas ", cex.lab=1.5,cex.main=1.5,font.lab=2)
abline(a=0,b=1,col='red')

# Ws
jSDM_lvs <- matrix(0,nsite,nl)
for (l in 1:nl){
  jSDM_lvs[,l] <- summary(mod_jSDM_Mosquitos$mcmc.latent[[paste0("lv_",l)]])[[1]][,"Mean"]
}
plot(mod_boral_Mosquitos$lv.mean, jSDM_lvs, xlab="variables latentes estimées par boral", ylab="variables latentes estimées par jSDM", main="Variables latentes W1 et W2", cex.lab=1.5,cex.main=1.5,font.lab=2)
abline(a=0,b=1,col='red')
# Predictions 
plot(probit_theta_pred_Mosquitos, mod_jSDM_Mosquitos$probit_theta_pred, xlab="probit(theta) estimé par boral", ylab="probit(theta) estimés par jSDM", main="Probit des probabilités de présence theta ",cex.lab=1.5,cex.main=1.5,font.lab=2)
abline(a=0,b=1,col='red')
```

## Eucalypts dataset : 455 sites and 12 species

### Fit with boral 
```{r boral-eucalypts, cache=TRUE, echo=F, include=F,eval=F}
# Import center and reduce Eucalypts dataset
data(eucalypts, package="jSDM")
head(eucalypts)
Env_Eucalypts <- cbind(scale(eucalypts[,c("Rockiness","VallyBotFlat","PPTann", "cvTemp","T0")]),eucalypts[,c("Sandiness","Loaminess")])
PA_Eucalypts <- eucalypts[,1:12]
Env_Eucalypts <- Env_Eucalypts[rowSums(PA_Eucalypts) != 0,]
# Remove sites where none species was recorded
PA_Eucalypts <- PA_Eucalypts[rowSums(PA_Eucalypts) != 0,]

# Fit the model 
T1 <- Sys.time()
mod_boral_Eucalypts <- boral(y=PA_Eucalypts, X=Env_Eucalypts, lv.control=list(num.lv=2, type="independent", distmat=NULL), family="binomial", row.eff="random", row.ids=matrix(c(1:nrow(PA_Eucalypts)),ncol=1), save.model=TRUE, calc.ics=F, hypparams=c(10,10,10,30), mcmc.control=list(n.burnin=10000, n.iteration=15000,n.thin=15,seed=123))
T2 <- Sys.time()
T_boral_Eucalypts <- difftime(T2,T1,units="mins")

# Probit des probabilités de présence theta  
probit_theta_pred_Eucalypts=mod_boral_Eucalypts$row.coefs$ID1$mean + as.matrix(Env_Eucalypts) %*% t(mod_boral_Eucalypts$X.coefs.mean)  + matrix(1,nrow=nrow(PA_Eucalypts), ncol=1)%*%mod_boral_Eucalypts$lv.coefs.mean[,"beta0"] + mod_boral_Eucalypts$lv.mean%*%t(mod_boral_Eucalypts$lv.coefs.mean[,-1])

# Deviance
logL=0
for (i in 1:nrow(PA_Eucalypts)){
  for (j in 1:ncol(PA_Eucalypts)){
    theta <- pnorm(probit_theta_pred_Eucalypts[i,j])
    logL=logL + dbinom(PA_Eucalypts[i,j],1,theta,1)  
  }
}
Deviance_boral_Eucalypts <- -2*logL
```

### Fit with jSDM 

```{r jSDM-eucalypts, cache=TRUE,echo=F, include=F,eval=F}
# Fit the model
T1 <- Sys.time()
mod_jSDM_Eucalypts <- jSDM_probit_block(
  presence_site_sp=as.matrix(PA_Eucalypts), 
  site_suitability=~.,   
  site_data=Env_Eucalypts, n_latent=2,
  burnin=10000, mcmc=15000, thin=15,
  alpha_start=0, beta_start=0, lambda_start=0, W_start=0,
  V_alpha_start=1, shape=0.5, rate=0.0005,
  mu_beta=0, V_beta=1.0E6,
  mu_lambda=0, V_lambda=10,
  seed=123, verbose=1)
T2 <- Sys.time()
T_jSDM_Eucalypts <- difftime(T2,T1,units="mins")
```

### Comparison of estimated parameters 
```{r jSDM-boral-Eucalypts, echo=F}
nsp <- ncol(mod_jSDM_Eucalypts$model_spec$presences)
nsite <- nrow(mod_jSDM_Eucalypts$model_spec$presences)
nl <- mod_jSDM_Eucalypts$model_spec$n_latent
np <- nrow(mod_jSDM_Eucalypts$model_spec$beta_start)
# Alpha et V_alpha
par(mfrow=(c(1,1)))
plot(mod_boral_Eucalypts$row.coefs$ID1$mean,colMeans(mod_jSDM_Eucalypts$mcmc.alpha), xlab="alphas estimés par boral", ylab="alphas estimés par  jSDM", main="Effets sites alphas",cex.lab=1.5,cex.main=1.5,font.lab=2)
abline(a=0,b=1,col='red')
points(mod_boral_Eucalypts$row.sigma$ID1["mean"],mean(mod_jSDM_Eucalypts$mcmc.V_alpha),
       pch=18, col ='red',cex=2.5)
legend("bottomright", legend=c("V_alpha"), pch =18 , col ='red',pt.cex =2, cex=1.2)

# Betas
jSDM_betas <- matrix(0,nsp,np)
for (j in 1:nsp){
  jSDM_betas[j,] <- summary(mod_jSDM_Eucalypts$mcmc.sp[[paste0("sp_",j)]])[[1]][1:np,"Mean"]
}
boral_betas <- cbind(mod_boral_Eucalypts$lv.coefs.mean[,"beta0"],mod_boral_Eucalypts$X.coefs.mean)

plot(boral_betas,jSDM_betas, xlab="betas estimés par boral", ylab="betas estimés par jSDM", main="Effets espèces betas ", cex.lab=1.5,cex.main=1.5,font.lab=2)
abline(a=0,b=1,col='red')

# Lambdas
jSDM_lambdas <- matrix(0,nsp,nl)
for (j in 1:nsp){
  jSDM_lambdas[j,] <- summary(mod_jSDM_Eucalypts$mcmc.sp[[paste0("sp_",j)]])[[1]][(np+1):(np+nl),"Mean"]
}
boral_lambdas <- mod_boral_Eucalypts$lv.coefs.mean[,-1]

plot(boral_lambdas,jSDM_lambdas, xlab="lambdas estimés par boral ", ylab="lambdas estimés par jSDM", main="Effets espèces lambdas ", cex.lab=1.5,cex.main=1.5,font.lab=2)
abline(a=0,b=1,col='red')

# Ws
jSDM_lvs <- matrix(0,nsite,nl)
for (l in 1:nl){
  jSDM_lvs[,l] <- summary(mod_jSDM_Eucalypts$mcmc.latent[[paste0("lv_",l)]])[[1]][,"Mean"]
}
plot(mod_boral_Eucalypts$lv.mean, jSDM_lvs, xlab="variables latentes estimées par boral", ylab="variables latentes estimées par jSDM", main="Variables latentes W1 et W2",cex.lab=1.5,cex.main=1.5,font.lab=2)
abline(a=0,b=1,col='red')

# Predictions 
plot(probit_theta_pred_Eucalypts, mod_jSDM_Eucalypts$probit_theta_pred, xlab="probit(theta) estimé par boral", ylab="probit(theta) estimés par jSDM", main="Probit des probabilités de présence theta ",cex.lab=1.5,cex.main=1.5,font.lab=2)
abline(a=0,b=1,col='red')
```

## Frogs dataset : 104 sites and 9 species

### Fit with boral 

```{r boral-frogs, cache=TRUE,echo=F, include=F,eval=F}
# Import center and reduce Frogs dataset
data(frogs, package="jSDM")
head(frogs)
Env_Frogs <- cbind(scale(frogs[,"Covariate_1"]),frogs[,"Covariate_2"],
                   scale(frogs[,"Covariate_3"]))
colnames(Env_Frogs) <- colnames(frogs[,1:3])
PA_Frogs <- frogs[,4:12]

# Fit the model
T1 <- Sys.time()
mod_boral_Frogs <- boral(y=PA_Frogs, X=Env_Frogs, lv.control=list(num.lv=2, type="independent", distmat=NULL), family="binomial", row.eff="random", row.ids=matrix(c(1:nrow(PA_Frogs)),ncol=1), save.model=TRUE, calc.ics=F, hypparams=c(10,10,10,30), mcmc.control=list(n.burnin=10000, n.iteration=15000,n.thin=15,seed=123))
T2 <- Sys.time()
T_boral_Frogs <- difftime(T2,T1,units="mins")

# Probit des probabilités de présence theta  
probit_theta_pred_Frogs=mod_boral_Frogs$row.coefs$ID1$mean + as.matrix(Env_Frogs) %*% t(mod_boral_Frogs$X.coefs.mean) + matrix(1,nrow=nrow(PA_Frogs),ncol=1)%*%mod_boral_Frogs$lv.coefs.mean[,"beta0"] + mod_boral_Frogs$lv.mean%*%t(mod_boral_Frogs$lv.coefs.mean[,-1])

# Deviance
logL=0
for (i in 1:nrow(PA_Frogs)){
  for (j in 1:ncol(PA_Frogs)){
    theta <- pnorm(probit_theta_pred_Frogs[i,j])
    logL=logL + dbinom(PA_Frogs[i,j],1,theta,1)  
  }
}
Deviance_boral_Frogs <- -2*logL
```

### Fit with jSDM 

```{r jSDM-frogs, cache=TRUE,echo=F, include=F,eval=F}
# Fit the model 
T1 <- Sys.time()
mod_jSDM_Frogs <- jSDM_probit_block(
  presence_site_sp=as.matrix(PA_Frogs), 
  site_suitability=~.,   
  site_data=as.data.frame(Env_Frogs), n_latent=2,
  burnin=10000, mcmc=15000, thin=15,
  alpha_start=0, beta_start=0, lambda_start=0, W_start=0,
  V_alpha_start=1, shape=0.5, rate=0.0005,
  mu_beta=0, V_beta=1.0E6,
  mu_lambda=0, V_lambda=10,
  seed=123, verbose=1)
T2 <- Sys.time()
T_jSDM_Frogs <- difftime(T2,T1,units="mins")
```

### Comparison of estimated parameters 

```{r jSDM-boral-frogs, echo=F}
nsp <- ncol(mod_jSDM_Frogs$model_spec$presences)
nsite <- nrow(mod_jSDM_Frogs$model_spec$presences)
nl <- mod_jSDM_Frogs$model_spec$n_latent
np <- nrow(mod_jSDM_Frogs$model_spec$beta_start)
# Alpha et V_alpha
par(mfrow=c(1,1))
plot(mod_boral_Frogs$row.coefs$ID1$mean,colMeans(mod_jSDM_Frogs$mcmc.alpha), xlab="alphas estimés par boral", ylab="alphas estimés par  jSDM", main="Effets sites alphas",cex.lab=1.5,cex.main=1.5,font.lab=2)
abline(a=0,b=1,col='red')
points(mod_boral_Frogs$row.sigma$ID1["mean"],mean(mod_jSDM_Frogs$mcmc.V_alpha),
       pch=18, col ='red',cex=2.5)
legend("bottomright", legend=c("V_alpha"), pch =18 , col ='red',pt.cex =2, cex=1.2)

# Betas
jSDM_betas <- matrix(0,nsp,np)
for (j in 1:nsp){
  jSDM_betas[j,] <- summary(mod_jSDM_Frogs$mcmc.sp[[paste0("sp_",j)]])[[1]][1:np,"Mean"]
}
boral_betas <- cbind(mod_boral_Frogs$lv.coefs.mean[,"beta0"],mod_boral_Frogs$X.coefs.mean)

plot(boral_betas,jSDM_betas, xlab="betas estimés par boral", ylab="betas estimés par jSDM", main="Effets espèces betas ",cex.lab=1.5,cex.main=1.5,font.lab=2)
abline(a=0,b=1,col='red')

# Lambdas
jSDM_lambdas <- matrix(0,nsp,nl)
for (j in 1:nsp){
  jSDM_lambdas[j,] <- summary(mod_jSDM_Frogs$mcmc.sp[[paste0("sp_",j)]])[[1]][(np+1):(np+nl),"Mean"]
}
boral_lambdas <- mod_boral_Frogs$lv.coefs.mean[,-1]

plot(boral_lambdas,jSDM_lambdas, xlab="lambdas estimés par boral ", ylab="lambdas estimés par jSDM", main="Effets espèces lambdas ",cex.main=1.5)
abline(a=0,b=1,col='red')

# Ws
jSDM_lvs <- matrix(0,nsite,nl)
for (l in 1:nl){
  jSDM_lvs[,l] <- summary(mod_jSDM_Frogs$mcmc.latent[[paste0("lv_",l)]])[[1]][,"Mean"]
}
plot(mod_boral_Frogs$lv.mean, jSDM_lvs, xlab="variables latentes estimées par boral", ylab="variables latentes estimées par jSDM", main="Variables latentes W1 et W2",cex.main=1.5)
abline(a=0,b=1,col='red')

# Predictions 
plot(probit_theta_pred_Frogs, mod_jSDM_Frogs$probit_theta_pred, xlab="probit(theta) estimé par boral", ylab="probit(theta) estimé par jSDM", main="Probit des probabilités de présence theta ",cex.main=1.5)
abline(a=0,b=1,col='red')
```

## Fungi dataset : 438 sites and 11 species

### Fit with boral 
```{r boral-fungi, cache=TRUE,echo=F, include=F,eval=F}

# Import center and reduce fungi dataset
data(fungi, package="jSDM")
Env_Fungi <- cbind(scale(fungi[,c("diam","epi","bark")]),
                   fungi[,c("dc1","dc2","dc3","dc4","dc5",
                            "quality3","quality4","ground3","ground4")])
colnames(Env_Fungi) <- c("diam","epi","bark","dc1","dc2","dc3","dc4","dc5",
                         "quality3","quality4","ground3","ground4")
PA_Fungi <- fungi[,c("antser","antsin","astfer","fompin","hetpar","junlut",
                     "phefer","phenig","phevit","poscae","triabi")]
Env_Fungi <- Env_Fungi[rowSums(PA_Fungi) != 0,]
# Remove sites where none species was recorded
PA_Fungi<- PA_Fungi[rowSums(PA_Fungi) != 0,]


# Fit the model 
T1 <- Sys.time()
mod_boral_Fungi <- boral(y=PA_Fungi, X=Env_Fungi, lv.control=list(num.lv=2, type="independent", distmat=NULL), family="binomial", row.eff="random", row.ids=matrix(c(1:nrow(PA_Fungi)),ncol=1), save.model=TRUE, calc.ics=F, hypparams=c(10,10,10,30), mcmc.control=list(n.burnin=10000, n.iteration=15000,n.thin=15,seed=123))
T2 <- Sys.time()
T_boral_Fungi <- difftime(T2,T1,units="mins")

# Probit des probabilités de présence theta  
probit_theta_pred_Fungi=mod_boral_Fungi$row.coefs$ID1$mean + as.matrix(Env_Fungi) %*% t(mod_boral_Fungi$X.coefs.mean) + matrix(1,nrow=nrow(PA_Fungi),ncol=1)%*%mod_boral_Fungi$lv.coefs.mean[,"beta0"] + mod_boral_Fungi$lv.mean%*%t(mod_boral_Fungi$lv.coefs.mean[,-1])

# Deviance
logL=0
for (i in 1:nrow(PA_Fungi)){
  for (j in 1:ncol(PA_Fungi)){
    theta <- pnorm(probit_theta_pred_Fungi[i,j])
    logL=logL + dbinom(PA_Fungi[i,j],1,theta,1)  
  }
}
Deviance_boral_Fungi <- -2*logL
```

### Fit with jSDM
```{r jSDM-fungi, cache=TRUE, echo=F, include=F,eval=F}
# Fit the model
T1 <- Sys.time()
mod_jSDM_Fungi <- jSDM_probit_block(
  presence_site_sp=as.matrix(PA_Fungi), 
  site_suitability=~.,   
  site_data=Env_Fungi, n_latent=2,
  burnin=10000, mcmc=15000, thin=15,
  alpha_start=0, beta_start=0, lambda_start=0, W_start=0,
  V_alpha_start=1, shape=0.5, rate=0.0005,
  mu_beta=0, V_beta=1.0E6,
  mu_lambda=0, V_lambda=10,
  seed=123, verbose=1)
T2 <- Sys.time()
T_jSDM_Fungi <- difftime(T2,T1,units="mins")
```

### Comparison of estimated parameters 

```{r jSDM-boral-fungi, echo=F}
nsp <- ncol(mod_jSDM_Fungi$model_spec$presences)
nsite <- nrow(mod_jSDM_Fungi$model_spec$presences)
nl <- mod_jSDM_Fungi$model_spec$n_latent
np <- nrow(mod_jSDM_Fungi$model_spec$beta_start)
# Alpha et V_alpha
par(mfrow=c(1,1))
plot(mod_boral_Fungi$row.coefs$ID1$mean,summary(mod_jSDM_Fungi$mcmc.alpha)[[1]][,"Mean"], xlab="alphas estimés par boral", ylab="alphas estimés par  jSDM", main="Effets sites alphas",cex.lab=1.5,cex.main=1.5,font.lab=2)
abline(a=0,b=1,col='red')
points(mod_boral_Fungi$row.sigma$ID1["mean"],summary(mod_jSDM_Fungi$mcmc.V_alpha)[[1]]["Mean"],
       pch=18, col ='red',cex=2.5)
legend("bottomright", legend=c("V_alpha"), pch =18 , col ='red',pt.cex =2, cex=1.2)

# Betas
jSDM_betas <- matrix(0,nsp,np)
for (j in 1:nsp){
  jSDM_betas[j,] <- summary(mod_jSDM_Fungi$mcmc.sp[[paste0("sp_",j)]])[[1]][1:np,"Mean"]
}
boral_betas <- cbind(mod_boral_Fungi$lv.coefs.mean[,"beta0"],mod_boral_Fungi$X.coefs.mean)

plot(boral_betas,jSDM_betas, xlab="betas estimés par boral", ylab="betas estimés par jSDM", main="Effets espèces betas estimés",cex.lab=1.5,cex.main=1.5,font.lab=2)
abline(a=0,b=1,col='red')

# Lambdas
jSDM_lambdas <- matrix(0,nsp,nl)
for (j in 1:nsp){
  jSDM_lambdas[j,] <- summary(mod_jSDM_Fungi$mcmc.sp[[paste0("sp_",j)]])[[1]][(np+1):(np+nl),"Mean"]
}
boral_lambdas <- mod_boral_Fungi$lv.coefs.mean[,-1]

plot(boral_lambdas,jSDM_lambdas, xlab="lambdas estimés par boral ", ylab="lambdas estimés par jSDM", main="Effets espèces lambdas ",cex.lab=1.5,cex.main=1.5,font.lab=2)
abline(a=0,b=1,col='red')

# Ws
jSDM_lvs <- matrix(0,nsite,nl)
for (l in 1:nl){
  jSDM_lvs[,l] <- summary(mod_jSDM_Fungi$mcmc.latent[[paste0("lv_",l)]])[[1]][,"Mean"]
}
plot(mod_boral_Fungi$lv.mean, jSDM_lvs, xlab="variables latentes estimées par boral", ylab="variables latentes estimées par jSDM", main="Variables latentes W1 et W2",cex.lab=1.5,cex.main=1.5,font.lab=2)
abline(a=0,b=1,col='red')
# Predictions 
plot(probit_theta_pred_Fungi, mod_jSDM_Fungi$probit_theta_pred, xlab="probit(theta) estimé par boral", ylab="probit(theta) estimés par jSDM", main="Probit des probabilités de présence theta ",cex.lab=1.5,cex.main=1.5,font.lab=2)
abline(a=0,b=1,col='red')
```

## Comparison of compilation time and deviance

```{r comparison-jSDM-boral, echo=FALSE, include=FALSE, eval=FALSE}
logL=0
for (i in 1:nrow(Y)){
  for (j in 1:ncol(Y)){
    logL=logL + dbinom(Y[i,j],1,pnorm(mod_jSDM_sim$probit_theta_pred[i,j]),1)  
  }
}
for( suffix in c("Mosquitos","Eucalypts","Frogs","Fungi")){
logL=0
for (i in 1:nrow(eval(parse(text=paste0("PA_", suffix)), env=.GlobalEnv))){
  for (j in 1:ncol(eval(parse(text=paste0("PA_", suffix)), env=.GlobalEnv))){
    theta <- pnorm(eval(parse(text=paste0("mod_jSDM_", suffix, "$probit_theta_pred[i,j]")), env=.GlobalEnv))
    logL=logL + dbinom(eval(parse(text=paste0("PA_", suffix)), env=.GlobalEnv)[i,j],1,theta,1)  
  }
}
assign(paste0("Deviance_jSDM_", suffix), -2*logL)
}

save(T_jSDM_sim, Deviance_jSDM_sim, RMSE_jSDM_sim, RMSE_boral_sim, T_boral_sim, Deviance_boral_sim, T_jSDM_Mosquitos, Deviance_jSDM_Mosquitos ,T_jSDM_Eucalypts, Deviance_jSDM_Eucalypts, T_jSDM_Frogs, Deviance_jSDM_Frogs,T_jSDM_Fungi, Deviance_jSDM_Fungi, T_boral_Mosquitos, Deviance_boral_Mosquitos, T_boral_Eucalypts, Deviance_boral_Eucalypts, T_boral_Frogs, Deviance_boral_Frogs, T_boral_Fungi, Deviance_boral_Fungi, 
     file="~/Documents/projet_BioSceneMada/Report/data/jSDM-boral-comparison.rda")
```